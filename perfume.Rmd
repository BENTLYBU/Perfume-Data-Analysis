---
title: "Perfume"
output: html_document
date: "2025-09-09"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Perfume Dataset Analysis (R)

This repository contains exploratory data analysis of the [Perfume Dataset](https://www.kaggle.com/datasets/ayushghawana/perfume-dataset) using **R**.

## ğŸ“Œ Introduction
Perfume is a lifestyle and fashion product that combines **brand identity, pricing, consumer preferences, and sensory attributes**.  
This project aims to explore patterns within the perfume dataset to understand:
- Brand distribution
- Pricing strategies
- Consumer ratings
- Longevity and sillage (lasting power & scent projection)

## ğŸ› ï¸ Tools
- **RStudio / R Markdown**
- R packages: `tidyverse`, `dplyr`, `ggplot2`, `readr`, `stringr`

```{r}
# Define function to check is package is installed
install_if_missing <- function(pkg){
  if (!require(pkg, character.only = TRUE)) {
    install.packages(pkg, dependencies = TRUE, repos = "https://cloud.r-project.org/")
    library(pkg, character.only = TRUE)
  }
}

# Install and load library
pkgs <- c("readr","dplyr","tidyr","stringr","janitor","ggplot2","ggrepel","scales","plotly","tibble")
invisible(lapply(pkgs, install_if_missing))
```


## ğŸ“‚ Project Structure
- `data/` â†’ raw dataset and cleaned dataset
- `scripts/` â†’ R scripts for data cleaning, analysis, visualization, modeling
- `notebooks/` â†’ R Markdown for step-by-step analysis
- `outputs/` â†’ figures, reports
- `docs/` â†’ research notes, methodology

## â“ Research Questions
1.Market share of men's and women's fragrances
2.Number of perfumes under each brands
3.Market shaer of each category and type
4.Gender preference of category and type
5.Will type/Category influence longevity 

## ğŸš€ Next Steps
- Perform data cleaning (handle missing values, duplicates, normalize categories)
- Conduct exploratory data analysis (EDA)
- Build visualizations with `ggplot2`
- Explore clustering/ML models (e.g., k-means, regression)

# Data read and clearning

```{r}
# Read in csv

perfume <- read.csv("Data/Perfumes_dataset.csv")

# Standarise
perfume <- perfume |>
  janitor::clean_names() |>
  dplyr::mutate(
    brand           = stringr::str_squish(brand),
    perfume         = stringr::str_squish(perfume),
    type            = stringr::str_squish(stringr::str_to_lower(type)),        # e.g. "edp", "edt"
    category        = stringr::str_squish(stringr::str_to_title(category)),    # "Fresh Scent" etc.
    target_audience = stringr::str_squish(stringr::str_to_title(target_audience)), # "Male/Female/Unisex"
    longevity       = stringr::str_squish(stringr::str_to_title(longevity))    # "Strong/Medium/..."
  )


```

```{r}
perfume[1:10,]
glimpse(perfume)
summary(perfume)
```
## Columns

*brand* â€“ The company or label that produces the perfume (e.g., Dumont).

*perfume* â€“ The name of the fragrance (e.g., Nitro Red).

*type* â€“ Concentration or formulation of the perfume (e.g., EDP â€“ Eau de Parfum).

*category* â€“ Classification of the fragrance based on scent family or style (e.g., Fresh Scent, Woody Spicy, Oriental Vanilla).

*target_audience* â€“ The intended wearer of the perfume (e.g., Male, Female, Unisex).

*longevity* â€“ Expected performance in terms of duration on the skin (e.g., Strong, Medium).

## Example Entries

*Nitro Red (Dumont, EDP)* â€“ A fresh scent designed for men with strong longevity.

*Celerio Oros (Dumont, EDP)* â€“ An oriental vanilla fragrance suitable for unisex wearers with medium longevity.

*Nitro Black (Dumont, EDP)* â€“ A woody spicy perfume for men with strong performance.

```{r}
# Find number of unique value in each column
sapply(perfume, function(x) length(unique(x)))
```
## Q1 Market share of men's and women's fragrances

```{r}
count_share <- function(df, group_vars){
  df |>
    dplyr::count(dplyr::across({{ group_vars }}), name = "n") |>
    dplyr::mutate(share = n / sum(n)) |>
    dplyr::arrange(dplyr::desc(n))
}

market_share_all <- count_share(perfume, target_audience)
print(market_share_all)
```

```{r}

market_share_all <- tibble::tibble(
  target_audience = c("Male","Female","Unisex"),
  n = c(375, 312, 88)
) %>%
  mutate(share = n / sum(n))

pie_df <- market_share_all %>%
  arrange(desc(share)) %>%
  mutate(
    label = paste0(target_audience, " (", percent(share, accuracy = 0.1), ")"),
    ypos  = cumsum(share) - share/2   # è§’åº¦ä¸­ç‚¹ï¼ˆé…åˆ coord_polar(theta="y")ï¼‰
  )
pie_df
# Draw the plot
ggplot(pie_df, aes(x = 1, y = share, fill = target_audience)) +
  geom_col(width = 1, color = "white") +
  coord_polar(theta = "y") +
  # å¤–ç½®æ ‡ç­¾ï¼šy ç”¨ä¸­ç‚¹ yposï¼Œx å›ºå®šåœ¨åŠå¾„=1ï¼Œå†ç”¨ nudge_x å¾€å¤–æ¨
  geom_label_repel(
    aes(y = ypos, label = label),
    x = 1,                 # åŠå¾„ä½ç½®
    nudge_x = 0.6,         # å¾€å¤–åç§»ï¼Œè°ƒå¤§æ›´é å¤–
    direction = "y",       # å‚ç›´æ–¹å‘æ’å¸ƒæ›´æ•´é½
    min.segment.length = 0, 
    segment.size = 0.5,
    segment.color = "grey40",
    box.padding = 0.25,
    point.padding = 0.2,
    size = 4,
    show.legend = FALSE
  ) +
  scale_fill_brewer(palette = "Set2") +
  labs(
    title = "Market Share of Fragrances by Target Audience",
    fill  = "Target Audience"
  ) +
  theme_void(base_size = 14) +
  theme(legend.position = "bottom")

```

Large variance show the difference inside a category and shared range indicates the range of difference inside one category. Based on these two standerds, we can Select k brands that are most differentiated. With the help of heatmap, we can clearly see the dominance of the market share of these brands on gender difference.

```{r}
# ====== ç»Ÿè®¡ï¼šæ€§åˆ« x ç±»åˆ«ï¼ˆæ•°é‡ + ç±»åˆ«å†…å æ¯”ï¼‰======
heat_df <- perfume %>%
  count(target_audience, category, name = "n") %>%
  group_by(category) %>%
  mutate(share = n / sum(n)) %>%
  ungroup()

# ====== å·¥å…·å‡½æ•°ï¼šé€‰æ‹©â€œæœ‰ä»£è¡¨æ€§â€çš„ç±»åˆ« ======
# method:
# - "top_total": é€‰æ€»é‡æœ€é«˜çš„å‰ k ä¸ªç±»åˆ«
# - "most_divergent": é€‰æ€§åˆ«å æ¯”å·®å¼‚ï¼ˆæ–¹å·®/æå·®ï¼‰æœ€å¤§çš„å‰ k ä¸ªç±»åˆ«
select_categories <- function(df, k = 20, method = c("top_total","most_divergent")){
  method <- match.arg(method)
  wide <- df %>%
    select(category, target_audience, n, share) %>%
    pivot_wider(names_from = target_audience, values_from = c(n, share), values_fill = 0)
  
  if (method == "top_total"){
    picked <- wide %>%
      mutate(total_n = rowSums(across(starts_with("n_")))) %>%
      arrange(desc(total_n)) %>%
      slice_head(n = min(k, nrow(.))) %>%
      pull(category)
  } else {
    # ç”¨â€œå æ¯”â€çš„æ–¹å·® + æå·® ä½œä¸ºâ€œå·®å¼‚åº¦â€æ‰“åˆ†
    picked <- wide %>%
      transmute(
        category,
        var_share  = apply(across(starts_with("share_")), 1, var),
        range_share = apply(across(starts_with("share_")), 1, function(x) diff(range(x)))
      ) %>%
      mutate(score = 0.5*var_share + 0.5*range_share) %>%
      arrange(desc(score)) %>%
      slice_head(n = min(k, nrow(.))) %>%
      pull(category)
  }
  picked
}

# ====== å·¥å…·å‡½æ•°ï¼šèšç±»/æ’åºåˆ—é¡ºåºï¼ˆè®©çƒ­åŠ›å›¾æ›´æœ‰ç»“æ„ï¼‰======
# å¯¹ç±»åˆ«Ã—æ€§åˆ«çŸ©é˜µåšå±‚æ¬¡èšç±»ï¼Œè¿”å›ç±»åˆ«é¡ºåº
cluster_category_order <- function(df, use = c("n","share")){
  use <- match.arg(use)
  mat <- df %>%
    select(category, target_audience, !!sym(use)) %>%
    pivot_wider(names_from = target_audience, values_from = !!sym(use), values_fill = 0) %>%
    column_to_rownames("category") %>%
    as.matrix()
  # ç”¨ç›¸å…³è·ç¦»æˆ–æ¬§å¼è·ç¦»éƒ½å¯ï¼›å æ¯”ç”¨æ¬§å¼é€šå¸¸å¤Ÿç”¨
  d <- dist(scale(mat, center = TRUE, scale = TRUE), method = "euclidean")
  hc <- hclust(d, method = "ward.D2")
  rownames(mat)[hc$order]
}

# ====== ä¸»å‡½æ•°ï¼šç”»äº¤äº’çƒ­åŠ›å›¾ï¼ˆplotlyï¼‰======
# metric: "count" æˆ– "share"
# pick_method: "top_total" æˆ– "most_divergent"
# k: å±•ç¤ºçš„ç±»åˆ«æ•°é‡
# cluster: æ˜¯å¦èšç±»æ’åº
plot_heatmap_q1 <- function(df = heat_df,
                            metric = c("count","share"),
                            pick_method = c("top_total","most_divergent"),
                            k = 20,
                            cluster = TRUE){
  metric <- match.arg(metric)
  pick_method <- match.arg(pick_method)
  metric_col <- if (metric == "count") "n" else "share"
  
  cats <- select_categories(df, k = k, method = pick_method)
  df_sub <- df %>% filter(category %in% cats)
  
  # åˆ—é¡ºåº
  if (cluster){
    cat_order <- cluster_category_order(df_sub, use = if(metric=="count") "n" else "share")
  } else {
    # éèšç±»æ—¶ï¼šæŒ‰æ€»é‡é™åºæ’
    cat_order <- df_sub %>%
      group_by(category) %>%
      summarise(tot = sum(.data[[metric_col]]), .groups = "drop") %>%
      arrange(desc(tot)) %>%
      pull(category)
  }
  
  # ç»„è£…çŸ©é˜µå’Œ hover æ–‡æœ¬
  mat <- df_sub %>%
    mutate(category = factor(category, levels = cat_order),
           target_audience = factor(target_audience, levels = c("Male","Female","Unisex"))) %>%
    arrange(target_audience, category) %>%
    select(category, target_audience, !!sym(metric_col)) %>%
    pivot_wider(names_from = category, values_from = !!sym(metric_col), values_fill = 0) %>%
    column_to_rownames("target_audience") %>%
    as.matrix()
  
  # hover ä¿¡æ¯ï¼šåŒæ—¶æ˜¾ç¤º count å’Œ share
  hover_df <- df_sub %>%
    mutate(category = factor(category, levels = cat_order),
           target_audience = factor(target_audience, levels = c("Male","Female","Unisex"))) %>%
    arrange(target_audience, category) %>%
    select(category, target_audience, n, share) %>%
    pivot_wider(names_from = category, values_from = c(n, share), values_fill = 0)
  
  # ç”Ÿæˆå’Œ mat åŒç»´åº¦çš„ hovertext
  audience_levels <- rownames(mat)
  hovertext <- matrix("", nrow = nrow(mat), ncol = ncol(mat))
  for (i in seq_along(audience_levels)){
    aud <- audience_levels[i]
    n_vec     <- as.numeric(hover_df %>% filter(target_audience == aud) %>% select(starts_with("n_")) )
    share_vec <- as.numeric(hover_df %>% filter(target_audience == aud) %>% select(starts_with("share_")) )
    hovertext[i, ] <- paste0(
      "Category: ", colnames(mat), "<br>",
      "Audience: ", aud, "<br>",
      "Count: ", n_vec, "<br>",
      "Share-in-Category: ", scales::percent(share_vec, accuracy = 0.1)
    )
  }
  
  # é¢œè‰²æ¡æ ‡é¢˜
  colorbar_title <- if (metric == "count") "Count" else "Share"
  
  # ç”»å›¾
  plotly::plot_ly(
    x = colnames(mat), y = rownames(mat),
    z = mat,
    type = "heatmap",
    colors = "Blues",            # è¿ç»­è‰²æ ‡
    hoverinfo = "text",
    text = hovertext,
    showscale = TRUE,
    colorbar = list(title = colorbar_title)
  ) %>%
    layout(
      title = paste0("Gender Ã— Category Heatmap (metric: ", colorbar_title, 
                     ", pick: ", pick_method, ", k=", k, if (cluster) ", clustered" else "" ,")"),
      xaxis = list(title = "Category", tickangle = 40, automargin = TRUE),
      yaxis = list(title = "Target Audience", automargin = TRUE)
    )
}

# ====== è°ƒç”¨ç¤ºä¾‹ ======
# 1) ç”¨â€œæ•°é‡â€ä½œå›¾ï¼Œé€‰â€œæœ€æœ‰å·®å¼‚â€çš„ 20 ä¸ªç±»åˆ«ï¼Œå¹¶åšèšç±»æ’åº
p1 <- plot_heatmap_q1(metric = "count", pick_method = "most_divergent", k = 20, cluster = TRUE)
p1

# 2) ç”¨â€œç±»åˆ«å†…å æ¯”â€ä½œå›¾ï¼Œé€‰â€œæ€»é‡æœ€é«˜â€çš„ 15 ä¸ªç±»åˆ«ï¼Œä¸èšç±»
p2 <- plot_heatmap_q1(metric = "share", pick_method = "top_total", k = 15, cluster = FALSE)
p2

```

From these two heat map, we can see that female are the main target audience of fragrance and 

## Q2 Number of perfumes under each brands

```{r}
brand_counts <- perfume |>
  dplyr::count(brand, name = "n") |>
  dplyr::arrange(dplyr::desc(n))
print(head(brand_counts, 20)) # å‰ 20 ä¸ªå“ç‰Œ
# å¦‚æœè¦å…¨éƒ¨ï¼Œè¯·ç›´æ¥ print(brand_counts)
```
```{r}
top10 <- brand_counts[1:10,]
p_bar <- ggplot(top10, aes(x = brand, y = n, fill = brand)) +
  geom_col(width = 0.7, color = "white") +
  geom_text(aes(label = n), hjust = 1.02, size = 3.8) +     # æ•°å­—åœ¨æ¡å†…å³ä¾§
  coord_flip() +
  scale_y_continuous(expand = expansion(mult = c(0, .05))) +
  scale_fill_brewer(palette = "Paired") +
  labs(
    title = "Top 10 Brands by Number of Perfumes",
    x = "Brand", y = "Count", fill = "Brand"
  ) +
  theme_minimal(base_size = 13) +
  theme(legend.position = "none",
        panel.grid.major.y = element_blank())
print(p_bar)

# ------------- B) Pie Chart (Top10 + Other) -------------
# ---- Top 10 å“ç‰Œæ•°æ® ----
top10 <- perfume %>%
  count(brand, name = "n") %>%
  arrange(desc(n)) %>%
  slice_max(n, n = 10) %>%
  mutate(share = n / sum(n),
         label = percent(share, accuracy = 0.1),
         ypos = cumsum(share) - share/2)   # æ¯ä¸ªæ‰‡åŒºä¸­ç‚¹

# ---- ç»˜åˆ¶æœ€ç®€å•çš„é¥¼å›¾ ----
ggplot(top10, aes(x = 1, y = share, fill = brand)) +
  geom_col(width = 1, color = "white") +
  coord_polar(theta = "y") +
  geom_text(aes(y = ypos, label = label),
            color = "white", size = 4, fontface = "bold") +
  scale_fill_brewer(palette = "Set3") +
  labs(
    title = "Market Share of Top 10 Perfume Brands",
    fill = "Brand"
  ) +
  theme_void(base_size = 14) +
  theme(legend.position = "right")
  
```



## Q3. Market share of each category and type

```{r}

category_share <- count_share(perfume, category)
print(head(category_share, 20))

type_share <- count_share(perfume, type)
print(type_share)

```

## Q4. Gender preference of category and type


```{r}
gender_in_category <- perfume |>
  dplyr::count(category, target_audience, name = "n") |>
  dplyr::group_by(category) |>
  dplyr::mutate(share_within_category = n / sum(n)) |>
  dplyr::arrange(category, dplyr::desc(share_within_category)) |>
  dplyr::ungroup()
print(head(gender_in_category, 30))

gender_in_type <- perfume |>
  dplyr::count(type, target_audience, name = "n") |>
  dplyr::group_by(type) |>
  dplyr::mutate(share_within_type = n / sum(n)) |>
  dplyr::arrange(type, dplyr::desc(share_within_type)) |>
  dplyr::ungroup()
print(gender_in_type)


```

## Q5. Will type/Category influence longevity?


```{r}
# ======================================================================
#     é€šè¿‡å¡æ–¹ç‹¬ç«‹æ€§æ£€éªŒ + CramÃ©r's Vï¼ˆæ•ˆåº”é‡ï¼‰è¯„ä¼°å…³è”å¼ºåº¦
# ======================================================================
cramers_v <- function(tbl){
  # tbl: contingency table
  chisq <- suppressWarnings(chisq.test(tbl))
  chi2  <- unname(chisq$statistic)
  n     <- sum(tbl)
  r     <- nrow(tbl)
  c     <- ncol(tbl)
  V     <- sqrt(chi2 / (n * (min(r-1, c-1))))
  list(
    chisq_test = chisq,
    cramer_v   = V
  )
}

cat("\n================ Q5: Does TYPE influence LONGEVITY? ==================\n")
tab_type_long <- table(perfume$type, perfume$longevity, useNA = "no")
res_type_long <- cramers_v(tab_type_long)
print(res_type_long$chisq_test)   # æ˜¾è‘—æ€§
cat(sprintf("Cramer's V: %.3f\n", res_type_long$cramer_v))

cat("\n================ Q5: Does CATEGORY influence LONGEVITY? ===============\n")
tab_cat_long <- table(perfume$category, perfume$longevity, useNA = "no")
res_cat_long <- cramers_v(tab_cat_long)
print(res_cat_long$chisq_test)
cat(sprintf("Cramer's V: %.3f\n", res_cat_long$cramer_v))

# -------- Optional: quick plots (uncomment if needed) --------
# ggplot(category_share, aes(x = reorder(category, share), y = share)) +
#   geom_col() + coord_flip() + labs(x="Category", y="Share", title="Market share by category")
#
# ggplot(type_share, aes(x = reorder(type, share), y = share)) +
#   geom_col() + coord_flip() + labs(x="Type", y="Share", title="Market share by type")
```

